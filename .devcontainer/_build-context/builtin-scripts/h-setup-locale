#!/bin/zsh -eu

# 防止在 locale 未生成时出现 perl 警告
export LC_ALL=C

run_sys() {
  if [[ "$EUID" -ne 0 ]]; then
    sudo "$@"
  else
    "$@"
  fi
}

if ! dpkg -s locales >/dev/null 2>&1; then
  run_sys apt-get update -qq
  run_sys apt-get install -qq -y --no-install-recommends locales
fi

run_sys sed -i "s/^# *en_US.UTF-8/en_US.UTF-8/" /etc/locale.gen
run_sys sed -i "s/^# *zh_CN.UTF-8/zh_CN.UTF-8/" /etc/locale.gen
run_sys locale-gen

zshrc="$HOME/.zshrc"
mkdir -p "${zshrc:h}"
touch "$zshrc"

# 将 locale 相关的环境变量添加到 .zshrc 的最前面
if ! grep -q '^export LC_ALL=zh_CN.UTF-8$' "$zshrc" 2>/dev/null; then
  sed -i '1i export LC_ALL=zh_CN.UTF-8' "$zshrc"
fi

if ! grep -q '^export LANG=zh_CN.UTF-8$' "$zshrc" 2>/dev/null; then
  sed -i '1i export LANG=zh_CN.UTF-8' "$zshrc"
fi
run_sys update-locale LANG=zh_CN.UTF-8 LC_ALL=zh_CN.UTF-8
