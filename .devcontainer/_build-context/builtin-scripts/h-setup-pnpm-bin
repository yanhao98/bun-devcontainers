#!/bin/bash -eu

# 验证文件校验和
# 参数 1: 文件路径
# 参数 2: 期望的 SHA256 校验和
verify_checksum() {
    local file="$1"
    local expected_checksum="$2"

    # sha256sum -c 需要 "hash  filename" 格式
    # 使用 - 表示从 stdin 读取
    echo "$expected_checksum  $file" | sha256sum -c - > /dev/null 2>&1
}

is_glibc_compatible() {
  getconf GNU_LIBC_VERSION >/dev/null 2>&1 || ldd --version >/dev/null 2>&1 || return 1
}

# 检测平台
if is_glibc_compatible; then
  platform="linux"
else
  platform="linuxstatic"
fi

arch="$(dpkg --print-architecture)"
case "${arch##*-}" in \
	amd64) build="$platform-x64";; \
	arm64) build="$platform-arm64";; \
	*) echo "错误: 不支持的架构: $arch"; exit 1 ;; \
esac

echo "正在获取 pnpm 最新版本信息..."
release_json=$(curl -s https://api.github.com/repos/pnpm/pnpm/releases/latest)

# 使用 jq 提取下载链接和 digest
# 注意：digest 格式通常为 "sha256:..."
asset_data=$(echo "$release_json" | jq -r --arg build "pnpm-$build" '.assets[] | select(.name == $build) | "\(.browser_download_url) \(.digest)"')

if [[ -z "$asset_data" ]]; then
    echo "错误: 未找到架构 $build 的 pnpm 发布资产"
    exit 1
fi

download_url=$(echo "$asset_data" | awk '{print $1}')
digest=$(echo "$asset_data" | awk '{print $2}')
expected_sha256="${digest#sha256:}"

echo "下载地址: $download_url"
echo "SHA256: $expected_sha256"

# 配置缓存目录
cache_dir="/vscode/pnpm"
sudo mkdir -p "$cache_dir" || true
sudo chown -R "$(whoami):$(whoami)" "$cache_dir" || true

pnpm_bin="$cache_dir/pnpm-$build"
need_download=true

# 检查是否存在且校验和匹配
if [[ -f "$pnpm_bin" ]]; then
    echo "发现已缓存的 pnpm 文件，正在验证校验和..."
    if verify_checksum "$pnpm_bin" "$expected_sha256"; then
        echo "校验和验证成功，使用缓存文件。"
        need_download=false
    else
        echo "校验和不匹配，将重新下载。"
    fi
fi

if [[ "$need_download" == "true" ]]; then
    echo "正在下载 pnpm..."
    curl --fail --location --progress-bar --output "$pnpm_bin" "$download_url"

    echo "正在验证下载文件的校验和..."
    if verify_checksum "$pnpm_bin" "$expected_sha256"; then
        echo "校验和验证成功。"
    else
        echo "错误: 校验和验证失败！"
        rm -f "$pnpm_bin"
        exit 1
    fi
fi

chmod +x "$pnpm_bin"

echo "正在运行 pnpm setup --force..."
# 设置 PNPM_HOME 环境变量，确保 setup 能够正常工作
export PNPM_HOME="$HOME/.local/share/pnpm"
# 运行 setup
"$pnpm_bin" setup --force

echo "✓ pnpm 安装成功"
